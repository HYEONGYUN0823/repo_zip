name: Deploy Spring Boot (Gradle) to EC2
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x ./zip/gradlew

    - name: Build with Gradle
      working-directory: ./zip
      run: ./gradlew bootJar

    - name: Deploy to EC2
      uses: easingthemes/ssh-deploy@v4.1.8
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.EC2_HOST }}
        REMOTE_USER: ${{ secrets.REMOTE_USER }}
        SOURCE: "zip/build/libs/"
        TARGET: "/home/ec2-user/zip"
        ARGS: "--exclude='.git*' --exclude='Jenkinsfile' --exclude='.github/' --exclude='zip/build/tmp/' --exclude='zip/build/reports/'"
        SCRIPT_AFTER: |
          cd /home/ec2-user/zip

          APP_PORT=8080
          echo "Attempting to stop any process on port ${APP_PORT}..."
          PID=$(sudo lsof -t -i:${APP_PORT})
          if [ -n "$PID" ]; then
            echo "Stopping process on port ${APP_PORT} (PID: $PID)"
            sudo kill -9 $PID
          else
            echo "No process found running on port ${APP_PORT}."
          fi

          JAR_FILE_TO_EXECUTE="zip-0.0.1-SNAPSHOT.jar"

          if [ -f "$JAR_FILE_TO_EXECUTE" ]; then
            echo "Starting Spring Boot application with direct secret injection..."
            
            # 실행 시 시크릿을 시스템 프로퍼티(-D)로 직접 주입합니다. (가장 확실한 방법)
            nohup java -jar \
              -Dspring.datasource.url="${{ secrets.MYSQL_MAIN_JDBC_URL }}" \
              -Dspring.datasource.username="${{ secrets.MYSQL_MAIN_USERNAME }}" \
              -Dspring.datasource.password="${{ secrets.MYSQL_MAIN_PASSWORD }}" \
              -Dcloud.aws.credentials.access-key="${{ secrets.CLOUD_AWS_CREDENTIALS_ACCESS_KEY }}" \
              -Dcloud.aws.credentials.secret-key="${{ secrets.CLOUD_AWS_CREDENTIALS_SECRET_ACCESS_KEY }}" \
              -Dcloud.aws.region.static="${{ secrets.CLOUD_AWS_REGION }}" \
              -Dcloud.aws.s3.bucket="${{ secrets.CLOUD_AWS_BUCKET }}" \
              -Dgoogle.mail.username="${{ secrets.GOOGLE_MAIL_USERNAME }}" \
              -Dgoogle.app.password="${{ secrets.GOOGLE_APP_PASSWORD }}" \
              -Dtoss.pay.api="${{ secrets.TOSSPAY_API }}" \
              -Dtoss.pay.cli.api="${{ secrets.TOSSPAY_CLI_API }}" \
              $JAR_FILE_TO_EXECUTE > /home/ec2-user/zip/app.log 2>&1 &
              
            echo "Spring Boot application started. Check logs at /home/ec2-user/zip/app.log"
          else
            echo "ERROR: Specified JAR file '$JAR_FILE_TO_EXECUTE' not found."
            ls -la /home/ec2-user/zip
            exit 1
          fi
