name: Deploy Spring Boot (Gradle) to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew # gradlew 파일은 repo_zip 루트에 있다고 가정

    # Gradle로 빌드 (zip 폴더 안의 build.gradle 사용)
    - name: Build with Gradle
      working-directory: ./zip # <<< 여기가 수정된 부분입니다 (작업 디렉토리 변경)
      run: ../gradlew bootJar # <<< 여기가 수정된 부분입니다 (상위 gradlew 실행)

    - name: Deploy to EC2
      uses: easingthemes/ssh-deploy@v5
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.EC2_HOST }}
        REMOTE_USER: ${{ secrets.REMOTE_USER }}
        # 빌드 결과물 경로는 zip 폴더를 기준으로 생각해야 합니다.
        # working-directory를 zip으로 설정했으므로, SOURCE 경로는 zip 폴더 내부를 기준으로 합니다.
        # 하지만 ssh-deploy 액션은 전체 체크아웃된 리포지토리 루트를 기준으로 SOURCE를 찾을 가능성이 높습니다.
        # 따라서 SOURCE는 'zip/build/libs/' 와 같이 명시하는 것이 안전합니다.
        SOURCE: "zip/build/libs/" # <<< 여기가 수정된 부분입니다 (SOURCE 경로 변경)
        TARGET: "/root/zip"
        ARGS: "--exclude='.git*' --exclude='Jenkinsfile' --exclude='.github/' --exclude='zip/build/tmp/' --exclude='zip/build/reports/'" # <<< ARGS의 경로도 수정
        SCRIPT_AFTER: |
          cd /root/zip

          APP_PORT=8080

          PID=$(sudo lsof -t -i:${APP_PORT})
          if [ -n "$PID" ]; then
            echo "Stopping process on port ${APP_PORT} (PID: $PID)"
            sudo kill -9 $PID
          else
            echo "No process found running on port ${APP_PORT}."
          fi

          JAR_FILE_TO_EXECUTE="zip-0.0.1-SNAPSHOT.jar" # 이 Jar 파일 이름은 zip/build/libs/ 안에 생성될 것으로 예상

          if [ -f "$JAR_FILE_TO_EXECUTE" ]; then
            echo "Starting Spring Boot application: $JAR_FILE_TO_EXECUTE"
            nohup java -jar $JAR_FILE_TO_EXECUTE > /root/zip/app.log 2>&1 &
            echo "Spring Boot application started. Check logs at /root/zip/app.log"
          else
            echo "ERROR: Specified JAR file '$JAR_FILE_TO_EXECUTE' not found in /root/zip."
            ls -la /root/zip
            exit 1
          fi