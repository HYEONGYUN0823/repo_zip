name: Deploy Spring Boot (Gradle) to EC2
on:
  push:
    branches:
      - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Grant execute permission for gradlew
      run: chmod +x ./zip/gradlew

    - name: Build with Gradle
      working-directory: ./zip
      run: ./gradlew bootJar

    - name: Deploy to EC2
      uses: easingthemes/ssh-deploy@v4.1.8
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.EC2_HOST }}
        REMOTE_USER: ${{ secrets.REMOTE_USER }}
        SOURCE: "zip/build/libs/"
        TARGET: "/home/ec2-user/zip"
        ARGS: "--exclude='.git*' --exclude='Jenkinsfile' --exclude='.github/' --exclude='zip/build/tmp/' --exclude='zip/build/reports/'"
        SCRIPT_AFTER: |
          # 1. 권한 강제 부여 (가장 중요)
          sudo chown -R ec2-user:ec2-user /home/ec2-user/zip
          sudo chmod -R 777 /home/ec2-user/zip
          
          cd /home/ec2-user/zip

          # 2. 기존 프로세스 종료
          APP_PORT=8080
          PID=$(sudo lsof -t -i:${APP_PORT})
          if [ -n "$PID" ]; then
            sudo kill -9 $PID
          fi

          # 3. 실행 (모든 이름의 변수를 강제 주입)
          JAR_FILE="zip-0.0.1-SNAPSHOT.jar"
          
          nohup java -jar \
            -Dcloud.aws.credentials.access-key="${{ secrets.CLOUD_AWS_CREDENTIALS_ACCESS_KEY }}" \
            -Dcloud.aws.credentials.secret-key="${{ secrets.CLOUD_AWS_CREDENTIALS_SECRET_ACCESS_KEY }}" \
            -Dcloud_aws_credentials_access_key="${{ secrets.CLOUD_AWS_CREDENTIALS_ACCESS_KEY }}" \
            -Dcloud_aws_credentials_secret_access_key="${{ secrets.CLOUD_AWS_CREDENTIALS_SECRET_ACCESS_KEY }}" \
            -Dspring.datasource.url="${{ secrets.MYSQL_MAIN_JDBC_URL }}" \
            -Dspring.datasource.username="${{ secrets.MYSQL_MAIN_USERNAME }}" \
            -Dspring.datasource.password="${{ secrets.MYSQL_MAIN_PASSWORD }}" \
            $JAR_FILE > /home/ec2-user/zip/app.log 2>&1 &
